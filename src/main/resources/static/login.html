<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Inventory — Login</title>

    <style>
        :root{
          --accent:#6C5CE7;
          --muted:#7b7b8a;
          --bg:#0f1724;
          --glass: rgba(255,255,255,0.04);
          --success:#16a34a;
          --danger:#ef4444;
          font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;background:var(--bg);color:#e6eef8;}
        .container{min-height:100vh;display:grid;place-items:center;padding:24px}
        .card{
          width:100%;
          max-width:480px;
          padding:28px;
          border-radius:14px;
          background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
          box-shadow:0 10px 35px rgba(0,0,0,0.45);
        }

        .h1{font-size:22px;margin:0 0 6px 0}
        .lead{color:var(--muted);font-size:13px;margin-bottom:16px}

        .field{margin-bottom:14px;display:flex;flex-direction:column;gap:6px}
        label{font-size:13px;color:#cfe2ff}
        .input{
          padding:12px 14px;
          border-radius:10px;
          border:1px solid rgba(255,255,255,0.06);
          background:var(--glass);
          color:inherit;
          font-size:14px;
        }
        .input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 2px rgba(108,92,231,0.3)}

        .btn{
          padding:10px 14px;
          border-radius:10px;
          border:none;
          cursor:pointer;
          font-weight:700;
        }
        .btn-primary{
          background:linear-gradient(90deg,var(--accent),#22c55e);
          color:white;
        }
        .btn-ghost{
          background:transparent;
          border:1px solid rgba(255,255,255,0.05);
          color:#dbeafe;
        }

        .feedback{font-size:13px;margin-top:6px}
        .feedback.error{color:var(--danger)}
        .feedback.ok{color:var(--success)}

        .modal{
          position:fixed;
          inset:0;
          background:rgba(0,0,0,0.50);
          display:none;
          align-items:center;
          justify-content:center;
        }
        .modal .box{
          background:#071022;
          padding:20px;
          border-radius:12px;
          width:90%;
          max-width:360px;
        }
        .modal input{
          width:100%;
          padding:10px;
          border-radius:8px;
          border:1px solid rgba(255,255,255,0.1);
          background:transparent;
          color:white;
        }

        .small{font-size:12px;color:var(--muted)}
        @media (max-width:480px){ .card{padding:18px} }
    </style>
</head>

<body>
<div class="container">
    <div class="card">
        <div class="h1">Inventory — Sign In</div>
        <div class="lead">Enter your email and password. Admins may be prompted for a secret key.</div>

        <form id="loginForm" novalidate>
            <div class="field">
                <label for="email">Email</label>
                <input id="email" class="input" type="text" placeholder="you@company.com" autocomplete="username" required>
                <div id="emailFeedback" class="feedback" aria-live="polite"></div>
            </div>

            <div class="field">
                <label for="password">Password</label>
                <input id="password" class="input" type="password" placeholder="Your password" autocomplete="current-password" required>
                <div id="passwordFeedback" class="feedback" aria-live="polite"></div>
            </div>

            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <button type="submit" class="btn btn-primary">Sign in</button>
                <button type="button" class="btn btn-ghost" id="gotoSignup">Create account</button>
            </div>

            <div id="serverMsg" class="feedback" style="margin-top:12px"></div>
            <div class="small" style="margin-top:8px">If admin creds are used the server will request a secret key; you will be prompted.</div>
        </form>
    </div>
</div>

<!-- ADMIN SECRET MODAL -->
<div id="secretModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="box">
        <h3 style="margin:0 0 8px 0">Admin Secret Required</h3>
        <p class="small" style="margin:0 0 10px 0">Enter admin secret key to continue.</p>

        <input id="adminSecret" type="password" placeholder="Admin secret" autocomplete="one-time-code">
        <div id="secretMsg" class="feedback" style="margin-top:8px"></div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
            <button class="btn btn-ghost" id="secretCancel">Cancel</button>
            <button class="btn btn-primary" id="secretSubmit">Submit</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API_BASE = 'http://localhost:8080';

    function showServerMessage(text, ok){
      const el = document.getElementById('serverMsg');
      el.textContent = text || '';
      el.className = ok ? 'feedback ok' : 'feedback error';
    }

    const loginForm       = document.getElementById('loginForm');
    const emailInput      = document.getElementById('email');
    const passInput       = document.getElementById('password');
    const emailFeedback   = document.getElementById('emailFeedback');
    const passwordFeedback= document.getElementById('passwordFeedback');

    loginForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      emailFeedback.textContent = '';
      passwordFeedback.textContent = '';
      showServerMessage('', true);

      const email    = emailInput.value.trim();
      const password = passInput.value;

      let ok = true;
      if (!email) {
        emailFeedback.textContent = 'Email required';
        emailFeedback.className = 'feedback error';
        ok = false;
      }
      if (!password) {
        passwordFeedback.textContent = 'Password required';
        passwordFeedback.className = 'feedback error';
        ok = false;
      }
      if (!ok) return;

      const payload = { email, password };

      try {
        const res = await fetch(`${API_BASE}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const raw = await res.text();
        let json = null;
        try { json = JSON.parse(raw); } catch(e){}

        // Admin secret required case
        if (res.status === 428 || (json && json.action === 'require_secret')) {
          openSecretModal(payload);
          return;
        }

        if (res.ok) {
          const data   = json && json.data ? json.data : null;
          const rights = data && data.rights ? String(data.rights).toLowerCase() : '';

          if (json && json.token) {
            try { localStorage.setItem('auth_token', json.token); } catch(e){}
          }
          if (rights) {
            try { localStorage.setItem('rights', rights); } catch(e){}
          }

          showServerMessage(json?.message || 'Login successful', true);

          // ROLE-BASED REDIRECTION
          setTimeout(() => {
            if (rights === 'admin') {
              window.location.href = `${API_BASE}/admin/dashboard.html`;
            } else {
              // default: staff or other non-admin roles
              window.location.href = `${API_BASE}/staff/dashboard.html`;
            }
          }, 500);
        } else {
          const msg = (json && (json.message || json.detail)) || raw || 'Login failed';
          showServerMessage(msg, false);
        }

      } catch(e) {
        showServerMessage('Network error', false);
      }
    });


    /* ADMIN SECRET MODAL */
    const secretModal      = document.getElementById('secretModal');
    const adminSecretInput = document.getElementById('adminSecret');
    const secretMsg        = document.getElementById('secretMsg');
    const secretSubmitBtn  = document.getElementById('secretSubmit');
    const secretCancelBtn  = document.getElementById('secretCancel');

    function openSecretModal(previousPayload) {
      secretModal.style.display = 'flex';
      secretModal.setAttribute('aria-hidden','false');
      adminSecretInput.value = '';
      secretMsg.textContent = '';
      adminSecretInput.focus();

      secretSubmitBtn.onclick = async () => {
        const secret = adminSecretInput.value.trim();
        if (!secret) {
          secretMsg.textContent = 'Secret required';
          secretMsg.className = 'feedback error';
          return;
        }

        const payload = { ...previousPayload, adminSecret: secret };

        try {
          const res = await fetch(`${API_BASE}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify(payload)
          });

          const raw = await res.text();
          let json = null;
          try { json = JSON.parse(raw); } catch(e){}

          if (res.ok) {
            const data   = json && json.data ? json.data : null;
            const rights = data && data.rights ? String(data.rights).toLowerCase() : 'admin';

            if (json && json.token) {
              try { localStorage.setItem('auth_token', json.token); } catch(e){}
            }
            try { localStorage.setItem('rights', rights); } catch(e){}

            showServerMessage(json?.message || 'Admin login successful', true);

            setTimeout(() => {
              closeSecretModal();
              // Admin-secret flow always goes to admin dashboard
              window.location.href = `${API_BASE}/admin/dashboard.html`;
            }, 500);
          } else {
            const msg = (json && json.message) || raw || 'Admin secret validation failed';
            secretMsg.textContent = msg;
            secretMsg.className = 'feedback error';
          }

        } catch(e){
          secretMsg.textContent = 'Network error';
          secretMsg.className = 'feedback error';
        }
      };

      secretCancelBtn.onclick = () => closeSecretModal();
    }

    function closeSecretModal(){
      secretModal.style.display = 'none';
      secretModal.setAttribute('aria-hidden','true');
      adminSecretInput.value = '';
      secretMsg.textContent = '';
    }

    document.getElementById('gotoSignup').addEventListener('click', () => {
      window.location.href = `${API_BASE}/signup.html`;
    });
</script>

</body>
</html>
